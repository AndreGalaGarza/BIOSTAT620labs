---
title: "lab-05"
author: "Andre Gala-Garza"
format: html
editor: visual
---

**Disclaimer:** Generative AI was used to assist with templating and writing code in this assignment; however, this code was checked manually and edited by hand to ensure accuracy.

**Source:** OpenAI. (2026). *ChatGPT (GPT-5.2 Thinking)* \[Large language model\]. <https://chatgpt.com/>.

# 1. Load packages

```{r}
library("data.table")
library("dplyr")
library("dtplyr")
library("tidyr")
```

# 2. Load population dataset
```{r}
url <- 'https://raw.githubusercontent.com/dmcable/BIOSTAT620W26/main/data/covid/population.csv'
if (!file.exists("population.csv"))
  download.file(
    url = url,
    destfile = "population.csv",
    method   = "libcurl",
    timeout  = 60
    )
population <- read.csv('population.csv')
```

```{r}
dim(population)
```

```{r}
head(population)
```

# 3. Examine and clean population matrix

```{r}
# Remove redundant index column and state column
population$X <- NULL
population$V4 <- NULL
head(population)
```

```{r}
# Make the first row the header
library("janitor")
population <- population %>%
  row_to_names(row_number = 1)
head(population)
```

```{r}
# Give columns better names and types
# Make data tidy (make "year" and "pop" columns)
colnames(population) <- c("2020", "2021", "state_name")
population <- population %>%
  pivot_longer(
    cols = c("2020", "2021"),
    names_to = "year", 
    values_to = "pop"
  ) %>%
  relocate(year, pop)

population$year <- as.integer(population$year)
population$pop <- as.integer(population$pop)
population <- as.data.frame(population)
rownames(population) <- 1:nrow(population)

head(population)
```

```{r}
# Create column for state abbreviations
state_lookup <- setNames(state.abb, state.name)
additional_states <- c("District of Columbia" = "DC",
                       "Puerto Rico" = "PR")
state_lookup <- c(state_lookup, additional_states)

population$state <- state_lookup[population$state_name]

head(population)
```

# 4. Make a regions dataframe
```{r}
library(jsonlite)
url <- "https://github.com/datasciencelabs/2024/raw/refs/heads/main/data/regions.json"
regions <- fromJSON(url) # use fromJSON to read as a data.frame

dim(regions)
```

```{r}
regions
```

```{r}
# Separate the lists of states to their own rows
# Make the "region" column a factor
regions <- unnest(regions, c(region, states), keep_empty = FALSE)
regions <- rename(regions, state_name = states)
regions$region <- as.factor(regions$region)
head(regions)
```

```{r}
# Rename value in region_name with a long name
unique(regions$region_name)
```

```{r}
regions$region_name[regions$region_name == "New York and New Jersey, Puerto Rico, Virgin Islands"] <- 'NY, NJ, PR, VI'
regions %>% filter(region_name == "NY, NJ, PR, VI")
```
# 5. Merge regions dataframe with population dataframe

```{r}
population <- left_join(population, regions, by = "state_name")
head(population)
```

# 6. Download state-level SARS-COV2 data
```{r}
library(httr2)
api <- "https://data.cdc.gov/resource/pwn4-m3yp.json"
request <- request(paste0(api,paste0("?$limit=10000000000")))
response <- request |> req_perform() |> resp_body_string()
cases_raw <- fromJSON(response)
head(cases_raw)
```

```{r}
dim(cases_raw)
```

The string "?$limit=10000000000" is an argument to the request named "limit" that specifies how many results to obtain from the JSON endpoint. By setting this limit to an extremely large number, the maximum possible number of rows from the dataset will be obtained; however, if we remove the limit argument, it is set to the default number of results on one page, which is 1,000. We can see that we obtained 10,380 records by setting the limit argument, which is actually more records than if we did not set a limit.

# 7. Wrangle the cases dataset
```{r}
colnames(cases_raw)
```

```{r}
# Select only the necessary columns
cases_clean <- cases_raw %>%
  select("state", "end_date", "tot_cases")
names(cases_clean) <- c("state", "date", "cases")
head(cases_clean)
```

```{r}
# Give columns better types
library(lubridate)
cases_clean$date <- as.Date(ymd_hms(cases_clean$date))
cases_clean$cases <- as.numeric(cases_clean$cases)
head(cases_clean)
```

# 8. Additional data wrangling
```{r}
# Merge population and cases dataframes
cases_clean$year <- year(cases_clean$date)
population <- left_join(population, cases_clean, by = c("state", "year"))
head(population)
```

```{r}
tail(population)
```

```{r}
# Sort population dataframe by state and by date within each state
population <- population[order(population$state, population$date), ]
head(population)
```

```{r}
tail(population)
```