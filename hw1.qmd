---
title: "hw1"
author: "Andre Gala-Garza"
format: html
editor: visual
embed-resources: true
---

**Disclaimer:** Generative AI was used to assist with templating and writing code in this assignment; however, this code was checked manually and edited by hand to ensure accuracy.

**Source:** OpenAI. (2026). *ChatGPT (GPT-5.2 Thinking)* \[Large language model\]. <https://chatgpt.com/>.

# 1. Exploratory data analysis

## Define question

We will work with air pollution data from the U.S. Environmental Protection Agency (EPA). The EPA has a national monitoring network of air pollution sites that measure particulate matter (PM) concentrations. The primary question we will answer is whether daily concentrations of PM (particulate matter air pollution with aerodynamic diameter less than 2.5 μm) decreased in Michigan over the 20 years spanning from 2005 to 2025.

## EDA Step 1: Download and read data
The 2005 and 2025 PM2.5 air quality data for all sites in Michigan were downloaded from the [BIOSTAT 620 GitHub repository](https://github.com/dmcable/BIOSTAT620W26/blob/main/data/airqual), as MI_05.csv and MI_25.csv.

```{r}
pm_2005 <- read.csv("MI_05.csv")
pm_2025 <- read.csv("MI_25.csv")
```

## EDA Step 2: Check data size

```{r}
dim(pm_2005)
```

```{r}
dim(pm_2025)
```

## EDA Step 3: Examine variables and their types

```{r}
names(pm_2005)
```

```{r}
names(pm_2025)
```

```{r}
str(pm_2005)
```

```{r}
str(pm_2025)
```

## EDA Step 4: Look at top/bottom of data

```{r}
head(pm_2005)
```

```{r}
tail(pm_2005)
```

```{r}
head(pm_2025)
```

```{r}
tail(pm_2025)
```

## EDA Step 5: Visualize the distribution of PM_2.5

```{r}
library(dplyr)
library(ggplot2)
library(lubridate)

df <- pm_2005

df2 <- df %>%
  mutate(
    Date = mdy(Date),
    PM_2_5 = as.numeric(Daily.Mean.PM2.5.Concentration)
  )
```

```{r}
# Numeric summary
summary(df2$PM_2_5)
quantile(df2$PM_2_5, probs = c(0, .01, .05, .10, .25, .50, .75, .90, .95, .99, 1), na.rm = TRUE)
mean(df2$PM_2_5, na.rm = TRUE)
sd(df2$PM_2_5, na.rm = TRUE)
```

```{r}
ggplot(df2, aes(x = PM_2_5)) +
  geom_histogram(bins = 60) +
  labs(title = "PM2.5 daily mean distribution (Michigan)", x = "PM2.5 (µg/m³)", y = "Count")
```

```{r}
# Boxplot
ggplot(df2, aes(y = PM_2_5)) +
  geom_boxplot() +
  labs(title = "PM2.5 daily mean (Michigan) boxplot", y = "PM2.5 (µg/m³)")
```

## EDA Summary

After reading the data into R, we find that both the 2005 and 2025 PM2.5 data have 22 variables (columns), which have the same names between the datasets. The 2005 data have 5,280 records (rows), while the 2025 data have 9,934 records.

The variables in the data include important information such as state, county, latitude, longitude, date, units of measurement, and the most important variable: the PM2.5 measurement, recorded as "Daily.Mean.PM2.5.Concentration". Some variables encode the same element in different ways, such as "State.FIPS.Code" and "State", although they are both the "chr" data type in this case. Other variables like latitude, longitude, and "Daily.Mean.PM2.5.Concentration" have the "num" datatype to store floating-point numbers.

From examining the top and bottom of each dataset, many of the values are grouped into similar sets, so the values at the top and bottom are frequently the same. The exception is "Daily.Mean.PM2.5.Concentration", which always sees significant changes between records.

From observing the histogram of the distribution of PM2.5, we find that the distribution is right-skewed, with the mean located at roughly 8 µg/m\^3. The frequency of PM2.5 concentrations decreases sharply after this point, with a very small number of records surpassing 50 µg/m\^3. The boxplot of Michigan records confirms that any records above 40 µg/m\^3 are considered outliers.

# 2. Combine data frames into one

```{r}
library(dplyr)
library(lubridate)

clean_pm <- function(df) {
  df %>%
    mutate(
      Date = mdy(Date),
      year = as.integer(format(Date, "%Y")),
      pm25 = as.numeric(Daily.Mean.PM2.5.Concentration),
      state = State,
      county = County,
      site = Site.ID
    ) %>%
    select(state, county, site, year, Date, pm25,
           Site.Latitude, Site.Longitude, Method.Code, Method.Description, Units) %>%
    arrange(state, county, site, Date)
}

pm_all <- bind_rows(
  clean_pm(pm_2005),
  clean_pm(pm_2025)
)
```

```{r}
dplyr::count(pm_all, year)
```

```{r}
summary(pm_all$pm25)
```

```{r}
str(pm_all)
```

```{r}
head(pm_all)
```

```{r}
tail(pm_all)
```

```{r}
ggplot(pm_all, aes(x = pm25)) +
  geom_histogram(bins = 60) +
  labs(title = "PM2.5 daily mean distribution (2005 & 2025)", x = "PM2.5 (µg/m³)", y = "Count")
```

# 3. Create leaflet map to show monitoring site locations

```{r}
library(dplyr)
library(leaflet)

# Filter to Michigan data
df <- pm_all %>% filter(state == "Michigan")

# One row per site per year
sites_year <- df %>%
  filter(!is.na(Site.Latitude), !is.na(Site.Longitude)) %>%
  distinct(year, state, county, site, Site.Latitude, Site.Longitude)

pal <- colorFactor(palette = c("dodgerblue3", "tomato3"), domain = sort(unique(sites_year$year)))

m <- leaflet(sites_year) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    lng = ~Site.Longitude, lat = ~Site.Latitude,
    radius = 5, stroke = FALSE, fillOpacity = 0.85,
    color = ~pal(year),
    popup = ~paste0(
      "<b>Year:</b> ", year, "<br/>",
      "<b>Site:</b> ", state, "-", county, "-", site, "<br/>",
      "<b>Lat/Lon:</b> ", round(Site.Latitude, 4), ", ", round(Site.Longitude, 4)
    )
  ) %>%
  addLegend(
    position = "bottomright",
    pal = pal, values = ~year,
    title = "Year", opacity = 1
  )

m
```

```{r}
# Counts by year
sites_year %>%
  count(year, name = "n_sites")
```

```{r}
# Bounding box by year (rough geographic footprint)
sites_year %>%
  group_by(year) %>%
  summarize(
    n_sites = n(),
    lat_min = min(Site.Latitude), lat_max = max(Site.Latitude),
    lon_min = min(Site.Longitude), lon_max = max(Site.Longitude),
    .groups = "drop"
  )
```

```{r}
# Sites present in both years vs. only one year
site_id <- sites_year %>%
  mutate(site_id = paste(state, county, site, sep = "-")) %>%
  distinct(year, site_id)

site_id %>%
  count(site_id) %>%
  count(n, name = "n_sites") %>%
  mutate(present_in_years = n) %>%
  arrange(desc(present_in_years))
```

From the map, we find the the monitoring sites are not evenly spread across Michigan. Instead, they have the highest concentration in Southeeast Michigan (the Detroit - Ann Arbor - Downriver area) for both 2005 and 2025. This makes sense, as this would be the area in Michigan where the population - and thus the emission source - is the highest. There are additional clusters of sites in central/east-central Michigan, such as around Lansing and the Saginaw / Bay City / Flint region. Meanwhile, there are very few sites in western and northern Michigan (which were only introduced as of 2025), and a small amount in the Upper Peninsula. Overall, while the number of monitoring sites increased from 2005 to 2025, the spatial distribution of the sites across Michigan remained mostly unchanged.

# 4. Check for data issues

## Identify missing or implausible values

```{r}
library(dplyr)

df <- pm_all %>%
  mutate(
    year = as.integer(year),
    pm25 = as.numeric(pm25)
  )
```

```{r}
# 1) Missingness
df %>%
  summarize(
    n = n(),
    pm25_missing = sum(is.na(pm25)),
    pm25_missing_pct = mean(is.na(pm25)) * 100
  )
```

```{r}
df %>%
  group_by(year) %>%
  summarize(
    n = n(),
    pm25_missing = sum(is.na(pm25)),
    pm25_missing_pct = mean(is.na(pm25)) * 100,
    .groups = "drop"
  )
```

We find that there are no values in the dataset that are completely missing.

```{r}
# 2) Implausible values (negative, extremely large)
df %>%
  summarize(
    n_neg = sum(pm25 < 0, na.rm = TRUE),
    n_zero = sum(pm25 == 0, na.rm = TRUE),
    n_gt_500 = sum(pm25 > 500, na.rm = TRUE),
    n_gt_1000 = sum(pm25 > 1000, na.rm = TRUE)
  )
```

We find that there are only four measurements in the data that are exactly zero, and none that are negative or implausibly large. Since these measurements appear to be reasonable, we do not remove any records from the dataset.


```{r}
# 3) Distribution checks by year
df %>%
  group_by(year) %>%
  summarize(
    n = sum(!is.na(pm25)),
    min = min(pm25, na.rm = TRUE),
    p1 = quantile(pm25, 0.01, na.rm = TRUE),
    p5 = quantile(pm25, 0.05, na.rm = TRUE),
    median = median(pm25, na.rm = TRUE),
    p95 = quantile(pm25, 0.95, na.rm = TRUE),
    p99 = quantile(pm25, 0.99, na.rm = TRUE),
    max = max(pm25, na.rm = TRUE),
    mean = mean(pm25, na.rm = TRUE),
    sd = sd(pm25, na.rm = TRUE),
    .groups = "drop"
  )
```

From this table, we see an overall level shift since the mean and median significantly decreased from 2005 to 2025; the mean decreased from 13.77 to 8.3, and the median decreased from 11.0 to 6.3. The highest percentiles are also lower in 2025 compared to 2005, which suggests that the overall PM2.5 concentrations in the air were less in 2025. There are also outliers of very high maximum concentrations in both years (81.6 and 116.0 respectively), which could be caused by an extreme event such as a wildfire.

```{r}
# 4) Missing days per site-year
site_days <- df %>%
  filter(!is.na(pm25)) %>%
  group_by(state, county, site, year) %>%
  summarize(
    n_days = n_distinct(Date),
    .groups = "drop"
  )

site_days %>%
  group_by(year) %>%
  summarize(
    n_site_years = n(),
    min_days = min(n_days),
    p25_days = quantile(n_days, 0.25),
    median_days = median(n_days),
    p75_days = quantile(n_days, 0.75),
    max_days = max(n_days),
    .groups = "drop"
  )
```

This shows that 2025 has roughly the same number of site-year pairs as 2005, with more frequent coverage per day in 2025 (higher median and percentiles). Both years are covered across most of the days in the calendar year for at least one site, since the maximum number of days per site-year pair for both 2005 and 2025 are close to 365.

## Check methods used for data collection

```{r}
unique(pm_all$"Method.Description")
```

```{r}
library(dplyr)

df <- pm_all %>%
  mutate(
    year = as.integer(year),
    method_code = Method.Code,
    method_name = Method.Description
  )

# 1) Find counts of method codes
# 2005
methods <- df %>%
  filter(year == 2005) %>%
  group_by(method_code) %>%
  summarize(
    n = n(),
  ) %>%
  arrange(desc(n))

methods
```
```{r}
# 2025
methods <- df %>%
  filter(year == 2025) %>%
  group_by(method_code) %>%
  summarize(
    n = n(),
  ) %>%
  arrange(desc(n))

methods
```

We note that the number of observations with a missing method code was 0 in 2005, but this count increased to 2,543 observations with missing codes in 2025.

```{r}
library(stringr)

# 2) Distribution of Method.Name within each year (proportions among non-missing)
method_dist <- df %>%
  filter(!is.na(method_code)) %>%
  count(year, method_name, name = "n") %>%
  group_by(year) %>%
  mutate(prop = n / sum(n)) %>%
  arrange(year, desc(n)) %>%
  ungroup()

# 3) Top 10 method codes per year
top10 <- method_dist %>%
  group_by(year) %>%
  slice_max(n, n = 10, with_ties = FALSE) %>%
  ungroup() %>%
  mutate(method_wrap = str_wrap(method_name, width = 35))

ggplot(top10, aes(x = prop, y = reorder(method_wrap, prop))) +
  geom_col() +
  facet_wrap(~ year, scales = "free_y") +
  labs(x = "Proportion within year", y = "Method")
```

From the [EPA PM2.5 Codetable](https://aqs.epa.gov/aqsweb/documents/codetables/methods_speciation.html), we find that the most common method names in 2005 correspond to codes 118 and 810 ("R & P Model 2025 PM2.5 Sequential w/WINS" and "Met One SASS/SuperSASS Teflon"), respectively, while the most common codes in 2025 are 636 and 170 ("Teledyne T640 at 5.0 LPM w/Network Data Alignment enabled" and "Met One BAM-1020 Mass Monitor w/VSCC"), respectively. However, the more helpful information is the proportion with respect to method names.

From 2005 to 2025, there is a big shift in the dominant measurement technology - instead of the overwhelming presence of gravimetric, filter-based samplers, there are more continuous and automated instrumenets (such as Teledyne for broadband spectroscopy and Met One for beta attenuation). Overall, there is a more diverse set of instruments being used in 2025 compared to in 2005, with the most frequently used method in 2025 being a smaller proportion (about 50% of the time) compared to in 2005 (over 80% of the time). These temporal patterns are important to analyze because they reflect how methodologies have been modernized over the past 20 years to include new types of instruments. In this case, the new instruments can measure PM2.5 concentrations in real time instead of only collecting samples at scheduled times.

However, the sharp increase in the presence of observations made with missing methods also highlights the importance of properly recording the methods used to make measurements, so that these types of trends can be discerned in the first place.

# 5. Visualize and summarize daily concentrations of PM2.5

```{r}
# Standardize, restrict to Michigan, and keep only years of interest
library(dplyr)
library(ggplot2)
library(stringr)

pm_mi <- pm_all %>%
  mutate(
    state  = if ("state"  %in% names(.)) state  else State.Code,
    county = if ("county" %in% names(.)) county else County.Code,
    site   = if ("site"   %in% names(.)) site   else Site.Num,
    pm25   = if ("pm25"   %in% names(.)) pm25   else as.numeric(Arithmetic.Mean),
    Date   = if ("Date"   %in% names(.)) as.Date(Date) else as.Date(Date.Local),
    year   = if ("year"   %in% names(.)) year   else as.integer(format(Date, "%Y")),
    county_name = if ("County.Name" %in% names(.)) County.Name else NA_character_,
    city_name   = if ("City.Name"   %in% names(.)) City.Name   else NA_character_,
    lat = as.numeric(if ("Latitude"  %in% names(.)) Latitude  else NA),
    lon = as.numeric(if ("Longitude" %in% names(.)) Longitude else NA)
  ) %>%
  filter(state == "Michigan", year %in% c(2005, 2025))
```

## Level 1: PM2 concentrations in Michigan overall

```{r}
state_summary <- pm_mi %>%
  group_by(year) %>%
  summarize(
    n_days = sum(!is.na(pm25)),
    mean = mean(pm25, na.rm = TRUE),
    median = median(pm25, na.rm = TRUE),
    p25 = quantile(pm25, 0.25, na.rm = TRUE),
    p75 = quantile(pm25, 0.75, na.rm = TRUE),
    p95 = quantile(pm25, 0.95, na.rm = TRUE),
    max = max(pm25, na.rm = TRUE),
    .groups = "drop"
  )

state_summary
```

```{r}
ggplot(pm_mi, aes(x = factor(year), y = pm25)) +
  geom_violin(trim = TRUE) +
  geom_boxplot(width = 0.15, outlier.alpha = 0.2) +
  labs(x = "Year", y = "Daily PM2.5 (µg/m³)", title = "Michigan daily PM2.5: 2005 vs 2025") +
  coord_cartesian(ylim = c(0, quantile(pm_mi$pm25, 0.99, na.rm = TRUE)))

```

```{r}
ggplot(pm_mi, aes(x = pm25)) +
  geom_histogram(bins = 60) +
  facet_wrap(~ year, ncol = 1) +
  labs(x = "Daily PM2.5 (µg/m³)", y = "Count", title = "Distribution of daily PM2.5 in Michigan") +
  coord_cartesian(xlim = c(0, quantile(pm_mi$pm25, 0.99, na.rm = TRUE)))

```

```{r}
pm_mi_month <- pm_mi %>%
  mutate(month = as.Date(format(Date, "%Y-%m-01"))) %>%
  group_by(year, month) %>%
  summarize(pm25_mean = mean(pm25, na.rm = TRUE), .groups = "drop")

ggplot(pm_mi_month, aes(x = month, y = pm25_mean, group = factor(year))) +
  geom_line() +
  labs(x = "Month", y = "Mean daily PM2.5 (µg/m³)", title = "Monthly mean PM2.5 (Michigan)") 
```

The summary statistics show that the mean and all of the percentiles (except for the max) of the daily PM2.5 concentration per month have decreased from 2005 to 2025; for example, the mean concentration decreased from 13.77 to 8.3 μg/m\^3. The side-by-side box/violin plots and histograms also illustrate this well by showing a high frequency of values around 5 μg/m\^3 in 2025, while concentrations of 20 μg/m\^3 or higher (which were considered evenly distrbuted in 2005) are considered outliers in 2025. In general, the violin plot and line plot show that the distribution of concentrations has shifted down.

## Level 2: PM2 concentrations by Michigan county

```{r}
county_summary <- pm_mi %>%
  filter(!is.na(county)) %>%
  group_by(year, county) %>%
  summarize(
    n = sum(!is.na(pm25)),
    mean = mean(pm25, na.rm = TRUE),
    median = median(pm25, na.rm = TRUE),
    p95 = quantile(pm25, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

county_summary
```

```{r}
county_change <- county_summary %>%
  select(year, county, mean, median, p95) %>%
  tidyr::pivot_wider(names_from = year, values_from = c(mean, median, p95)) %>%
  mutate(
    d_mean   = mean_2025   - mean_2005,
    d_median = median_2025 - median_2005,
    d_p95    = p95_2025    - p95_2005
  )

county_change %>% arrange(d_mean)
```

```{r}
county_levels <- county_change %>%
  arrange(abs(d_mean)) %>%
  pull(county)

plot_df <- county_summary %>%
  mutate(county = factor(county, levels = county_levels))

ggplot(plot_df, aes(x = county, y = mean, color = factor(year), group = county)) +
  geom_line(color = "grey50") +
  geom_point(size = 2) +
  labs(x = "County", y = "Mean daily PM2.5 (μg/m^3)", color = "Year",
       title = "Mean daily PM2.5 by county (ordered by |Δ mean|)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

From this plot, we can see that out of every county in Michigan where measurements were recorded in both 2005 and 2025, all of the measurements from 2025 are significantly smaller than those in 2005 (except for Schoolcraft where the reverse is true). According to the summary statistics, the median and 95th percentile also uniformly decrease from 2005 to 2025. The decreases in concentrations range from -2.81 (in Keweenaw) to -7.53 μ/m\^3 (in Wayne), meaning the concentrations decreased by at least 4 μ/m\^3 and up to almost 8 μ/m\^3 by county from 2005 to 2025.

We also see an overall decrease when comparing the 7 measurements for counties only taken in 2005 compared to the 3 measurements for counties only taken in 2025, since none of the measurements from counties only recorded in 2025 are higher than 8 μg/m\^3.

```{r}
library(maps)

mi_map <- map_data("county") %>%
  filter(region == "michigan") %>%
  mutate(county = str_to_title(subregion))

county_map_df <- mi_map %>%
  left_join(county_change, by = "county")

ggplot(county_map_df, aes(long, lat, group = group, fill = d_mean)) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_quickmap() +
  labs(title = "Change in mean PM2.5 (2025 - 2005) by Michigan county",
       fill = "Δ mean") 

```

This choropleth shows the changes in mean PM2.5 concentrations per Michigan county from 2005 to 2025. We can see that the largest decreases (the deepest blue colors) are in counties in the southeast region of Michigan, which (as discussed previously) is where Metro Detroit is located. This suggests that the decreases are concentrated in metro/industrial areas, and the decreases are less pronounced in more rural counties closer to the north side of Michigan.

## Level 3: PM2 concentrations by site in Wayne County

```{r}
pm_wayne <- pm_mi %>%
  filter(county == "Wayne") %>%
  mutate(site_id = paste0(county, "-", site))

site_summary <- pm_wayne %>%
  group_by(year, site_id, city_name) %>%
  summarize(
    n = sum(!is.na(pm25)),
    mean = mean(pm25, na.rm = TRUE),
    median = median(pm25, na.rm = TRUE),
    p95 = quantile(pm25, 0.95, na.rm = TRUE),
    .groups = "drop"
  )

site_summary
```

```{r}
ggplot(pm_wayne, aes(x = site_id, y = pm25)) +
  geom_boxplot(outlier.alpha = 0.2) +
  facet_wrap(~ year, scales = "free_x") +
  labs(x = "Site", y = "Daily PM2.5", title = "Wayne County: daily PM2.5 by site") +
  coord_cartesian(ylim = c(0, quantile(pm_wayne$pm25, 0.99, na.rm = TRUE))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
```

```{r}
wayne_sites <- pm_wayne %>%
  filter(!is.na(Site.Latitude), !is.na(Site.Longitude)) %>%
  distinct(year, site_id, city_name, Site.Latitude, Site.Longitude)

ggplot(wayne_sites, aes(x = Site.Longitude, y = Site.Latitude, color = factor(year))) +
  geom_point(size = 3, alpha = 0.8) +
  labs(x = "Longitude", y = "Latitude", color = "Year",
       title = "Wayne County monitor locations by year") +
  coord_quickmap()
```

From the series of boxplots that show the distribution of daily PM2.5 concentrations in all of the Wayne County sites, we see that the medians have uniformly decreased from 2005 to 2025; in fact, according to the summary statistics, the lowest mean and median concentrations in 2005 are still higher than the highest mean and median concentrations in 2025. The boxplots also show (much like the broad, state-wide analysis from before) that the concentrations above 20 μg/m\^3 are within the 75th percentile in 2005, but outliers in 2025. Finally, the spatial plot of site locations colored by year shows that the sites in 2005 (red points) are more spread out across Wayne County, but in 2025 (blue points), they are more clustered in one area between latitude 42.30 and longitude -83.15, with only three sites located away from that cluster.

Therefore, we can finally conclude that on the level of the entire state of Michigan, on the level of each county within Michigan, and the level of each observation site within Wayne County, the daily concentrations of PM2.5 have decreased in Michigan over the 20 years spanning from 2005 to 2025.
